<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
  html{
    height: 100%;
    overflow: hidden;
  }
  body{
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  div.webviews{
    display: flex;
    flex-direction: column;
    flex-grow:1;
  }
  webview{display: none;width:100%;height:100%}
  .curWV{display: inherit !important;}
</style>
<script>
  var iTab = 0;
  var tabs;
  var engines = {};
  var focusMesg;
  let lastKeyPressed;
  let lastKeyPressed_millis = 0;
  function switchTab(i){
    let tab = tabs.children[iTab];
    if(document.activeElement == tab) tab.blur();
    tab.classList.remove('curWV');
    iTab = i;
    tabs.children[iTab].classList.add('curWV');
  }
  function newTab(){
    var tab = document.createElement('webview');
    tab.allowpopups = true;
    tabs.appendChild(tab);
  }
  function tabInc(num){
    let nTabs = tabs.children.length;
    if(nTabs<2) return;
    let i = iTab +num;
    if(i>=nTabs) i=0;
    switchTab(i);
  }
  function tabDec(num){
    let nTabs = tabs.children.length;
    if(nTabs<2) return;
    let i = iTab +num;
    if(i<0) i=nTabs-1;
    switchTab(i);
  }
  function tabClose(){
    let nTabs = tabs.children.length;
    if(nTabs<2) return "";//no remain tab
    let tab = tabs.children[iTab];
    if(document.activeElement == tab) tab.blur();
    tabs.removeChild(tab);
    nTabs--;
    if(iTab>=nTabs) iTab=iTab-1;
    tabs.children[iTab].classList.add('curWV');
    return getWinTitle();
  }
  function getWinTitle(){
    let t=tabs.children[iTab];
    let title = (iTab+1) + '/' + tabs.children.length;
    try{title=title+' '+t.getTitle()+' '+t.getURL()}catch(e){}
    return title
  }
  function appendAutoc(str){
    let dl = document.forms[0].children[0];
    let lines = str.split('\n');
    for(let line of lines){
      let opt = document.createElement('option');
      opt.value = line;
      dl.appendChild(opt);
    }
  }
  function keyPress(e){
    var inputE = document.forms[0].q;
    if (e.ctrlKey||e.altKey||e.metaKey)
      return;
    var key = e.key;
    switch(key){
    case "PageDown":
    case "PageUp":
      focusMesg ="javascript:alert('hi');{let e=new KeyboardEvent('keydown',{key:'"+key+
	  "'});document.dispatchEvent(e)}";
      tabs.children[iTab].focus();
      return;
    }
    if(inputE === document.activeElement) return;
    var curMillis = Date.now();
    if(curMillis-lastKeyPressed_millis>1000)
      lastKeyPressed = null;
    lastKeyPressed_millis = curMillis;

    switch (key) {
    case "!":
      inputE.value = ":";
      inputE.focus();
      lastKeyPressed = null;
      return;
    case "/":
    case ":":
      inputE.value = "";
      inputE.focus();
      lastKeyPressed = null;
      return;
    }
    if("u"===lastKeyPressed){
    }
  }
  function getQ(){return document.forms[0].q.value;}
  function bang(query, iSpace){
    let name = query.slice(0,iSpace);
    let engine = engines[name];
    if(engine)
      return engine+query.substring(iSpace+1);
    return "https://www.bing.com/search?q="+query;
  }
  function coloncommand(q){
    if(98==q.charCodeAt(1) &&
       (2==q.length || 32==q.charCodeAt(2))){ //":b [filename]" for bookmark
      let tab = tabs.children[iTab];
      q= q+ " " + tab.getURL() + " " + tab.getTitle();
    }
    document.title = q;
  }
  function handleQuery(q){
    if(q.length>1){
      let c0=q.charCodeAt(0);
      switch(c0){
      case 47://"/"
        tabs.children[iTab].findInPage(q.substring(1));
        return;
      case 58://':'
        coloncommand(q);
        return;
      }
    }
    var url=q;
    do {
      if(q.length>7){
        let c6 = q.charCodeAt(6);
        if(47==c6){// '/'
          let c5 = q.charCodeAt(5);
          if(47==c5 && 58==q.charCodeAt(4))//http/file urls
            break;
          if(58==c5 && 47==q.charCodeAt(7))//https://
            break;
        }else if(q.startsWith("javascript:")) break;
      }
      let iS = q.indexOf(' ');
      if(iS<0 && q.indexOf('.')>0)
        url = 'https://'+q;
      else
        url = bang(q, iS);
    }while(false);
    tabs.children[iTab].src=url;
  }
</script>
</head>
<body>
  <form action="javascript:handleQuery(getQ())">
  <datalist id="autoc"></datalist>
  <input type="text" list="autoc" name=q style="width:100%" autofocus></form>
  <div class="webviews">
  <webview class="curWV" allowpopups></webview>
  </div>
  <script>
    tabs = document.body.children[1];
    document.addEventListener('keydown', keyPress);
  </script>
</body></html>
